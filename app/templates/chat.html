{% extends 'base.html' %}
{% block chat_widget %}{% endblock %}
{% block content %}
<style>
  /* Hide the main navigation in chat to prevent duplicate elements */
  .nav { display: none; }
  .container { margin-top: 0; padding: 0; max-width: 100%; }
  body { background: #f3f4f6; }
</style>

<style>
  :root {
    --primary: #4f46e5;
    --primary-dark: #4338ca;
    --bg-dark: #000000;
    --bg-darker: #000000;
    --text-dark: #ffffff;
    --text-light: #cccccc;
    --border-color: #333333;
    --bot-bubble: #1a1a1a;
    --bot-text: #ffffff;
    --user-bubble: #4f46e5;
    --user-text: #ffffff;
    --typing-animation: typing 1.5s infinite;
  }

  @keyframes typing {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  .chat-container {
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 800px;
    height: 90vh;
    max-height: 1000px;
    background: var(--bg-darker);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border-color);
  }

  .chat-header {
    padding: 18px 24px;
    background: #1a1a1a;
    color: var(--text-dark);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 2;
    border-bottom: 1px solid var(--border-color);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
  }

  .chat-header-title {
    flex: 1;
    text-align: center;
  }

  .chat-header h4 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: 0.5px;
  }

  .chat-header p {
    margin: 4px 0 0;
    font-size: 0.8rem;
    opacity: 0.9;
    font-weight: 400;
  }

  .language-selector {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .language-selector label {
    font-size: 0.85rem;
    font-weight: 500;
    opacity: 0.9;
  }

  .language-selector select {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background: #333333;
    color: var(--text-dark);
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .language-selector select:hover {
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
  }

  .language-selector select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
  }

  #chatbot-messages {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
    background: var(--bg-darker);
    display: flex;
    flex-direction: column;
    gap: 20px;
    scroll-behavior: smooth;
  }

  .message {
    display: flex;
    flex-direction: column;
    max-width: 85%;
    animation: messageAppear 0.3s ease-out;
  }

  @keyframes messageAppear {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .message-user {
    align-self: flex-end;
    align-items: flex-end;
  }

  .message-bot {
    align-self: flex-start;
    align-items: flex-start;
  }

  .message-content {
    padding: 14px 20px;
    border-radius: 12px;
    font-size: 1.05rem;
    line-height: 1.5;
    word-wrap: break-word;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    position: relative;
    transition: all 0.2s ease;
    max-width: 90%;
  }

  .message-user .message-content {
    background: var(--user-bubble);
    color: var(--user-text);
    border-bottom-right-radius: 4px;
    margin-left: auto;
  }

  .message-bot .message-content {
    background: var(--bot-bubble);
    color: var(--bot-text);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 4px;
    margin-right: auto;
  }

  .message-time {
    font-size: 0.7rem;
    color: var(--text-lighter);
    margin-top: 4px;
    padding: 0 8px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .message:hover .message-time {
    opacity: 1;
  }

  .typing-indicator {
    display: flex;
    gap: 8px;
    padding: 14px 24px;
    background: var(--bot-bubble);
    border-radius: 12px;
    width: fit-content;
    margin-bottom: 8px;
    border: 1px solid var(--border-color);
  }

  .typing-dot {
    width: 10px;
    height: 10px;
    background: var(--text-light);
    border-radius: 50%;
    opacity: 0.6;
  }

  .typing-dot:nth-child(1) { animation: var(--typing-animation) 0.75s -0.2s infinite; }
  .typing-dot:nth-child(2) { animation: var(--typing-animation) 0.75s -0.1s infinite; }
  .typing-dot:nth-child(3) { animation: var(--typing-animation) 0.75s infinite; }

  .chat-input-container {
    padding: 16px;
    background: #000000;
    border-top: 1px solid var(--border-color);
    backdrop-filter: blur(10px);
    position: relative;
  }

  #chatbot-form {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  #chatbot-text {
    flex: 1;
    padding: 16px 20px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    background: #ffffff;
    color: #000000;
    font-size: 1.1rem;
    transition: all 0.2s ease;
    resize: none;
    min-height: 60px;
    max-height: 200px;
    line-height: 1.5;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
  }

  #chatbot-text:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    background: #ffffff;
  }

  #chatbot-form button {
    padding: 0 24px;
    height: 60px;
    border-radius: 12px;
    background: var(--user-bubble);
    color: white;
    border: none;
    font-weight: 500;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 100px;
  }

  #chatbot-form button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
  }

  #chatbot-form button:active {
    transform: translateY(0);
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #1a1a1a;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb {
    background: #333333;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #444444;
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .chat-container {
      height: 100vh;
      border-radius: 0;
    }
    
    .message {
      max-width: 90%;
    }
    
    #chatbot-form {
      padding: 12px;
    }
    
    #chatbot-text {
      font-size: 1rem;
    }
  }
</style>

<div class="chat-wrapper" style="display: flex; justify-content: center; align-items: center; padding: 20px; min-height: 100vh; background: #000000;">
  <div class="chat-container">
    <!-- Chat Header -->
    <div class="chat-header">
      <div class="chat-header-title">
        <h4>Chat with DhanSetu</h4>
        <p>Ask me anything about our services</p>
      </div>
      <div class="language-selector">
        <label for="chat-lang">Language:</label>
        <select id="chat-lang">
          <option value="en">English</option>
          <option value="kn">Kannada</option>
        </select>
      </div>
    </div>

    <!-- Messages Container -->
    <div id="chatbot-messages" data-init="greet"></div>

    <!-- Input Area -->
    <div class="chat-input-container">
      <form id="chatbot-form" autocomplete="off">
        <input id="chatbot-text" name="message" type="text" placeholder="Type your message..." required>
        <button type="submit" id="send-button">Send</button>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  const box = document.getElementById('chatbot-messages');
  const form = document.getElementById('chatbot-form');
  const input = document.getElementById('chatbot-text');
  const sendButton = document.getElementById('send-button');
  let isTyping = false;

  // Format time as HH:MM
  function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  // Show typing indicator
  function showTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message message-bot';
    typingDiv.id = 'typing-indicator';
    typingDiv.innerHTML = `
      <div class="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    `;
    box.appendChild(typingDiv);
    box.scrollTop = box.scrollHeight;
    return typingDiv;
  }

  // Hide typing indicator
  function hideTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) {
      indicator.remove();
    }
  }

  // Add a new message to the chat
  function addMessage(role, text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${role}`;
    
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    messageContent.textContent = text;
    
    const timeSpan = document.createElement('span');
    timeSpan.className = 'message-time';
    timeSpan.textContent = getCurrentTime();
    
    messageDiv.appendChild(messageContent);
    messageDiv.appendChild(timeSpan);
    
    // Remove typing indicator if it exists
    hideTypingIndicator();
    
    box.appendChild(messageDiv);
    box.scrollTop = box.scrollHeight;
    
    // Add animation class
    setTimeout(() => {
      messageContent.style.transform = 'translateY(0)';
    }, 10);
    
    return messageDiv;
  }

  // Simulate typing effect
  async function simulateTyping(text, callback) {
    isTyping = true;
    sendButton.disabled = true;
    
    const typingIndicator = showTypingIndicator();
    
    // Simulate typing delay
    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
    
    hideTypingIndicator();
    
    // Add the message
    callback(text);
    
    isTyping = false;
    sendButton.disabled = false;
  }

  // Send message to server
  async function sendMessage(text) {
    if (!text.trim()) return;
    
    // Add user message immediately
    addMessage('user', text);
    
    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          message: text, 
          lang: document.getElementById('chat-lang')?.value || 'en' 
        })
      });
      
      const data = await response.json();
      
      // Simulate typing for bot response
      await simulateTyping(data.reply || 'Sorry, I could not process that.', (responseText) => {
        addMessage('bot', responseText);
      });
      
    } catch (error) {
      console.error('Error:', error);
      addMessage('bot', 'Sorry, there was an error processing your request. Please try again.');
    }
  }

  // Form submission
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text || isTyping) return;
      
      input.value = '';
      await sendMessage(text);
    });
  }
  
  // Auto-resize textarea
  if (input) {
    input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
    
    // Send message on Shift+Enter (new line) or just Enter (send)
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event('submit'));
      }
    });
  }

  // Initial greeting
  if (box && box.getAttribute('data-init') === 'greet') {
    const lang = document.getElementById('chat-lang')?.value || 'en';
    const greeting = lang === 'kn' 
      ? 'ನಮಸ್ಕಾರ! ನಾನು ಹೇಗೆ ಸಹಾಯ ಮಾಡಲಿ?' 
      : 'Hello! I\'m here to help. What would you like to know?';
    
    // Show greeting after a short delay
    setTimeout(() => {
      addMessage('bot', greeting);
    }, 500);
  }

  // Handle language change
  const langSelector = document.getElementById('chat-lang');
  if (langSelector) {
    langSelector.addEventListener('change', function() {
      // Clear existing messages
      box.innerHTML = '';
      
      // Show new greeting in selected language
      const lang = this.value;
      const greeting = lang === 'kn' 
        ? 'ನಮಸ್ಕಾರ! ನಾನು ಹೇಗೆ ಸಹಾಯ ಮಾಡಲಿ?' 
        : 'Hello! I\'m here to help. What would you like to know?';
      
      setTimeout(() => {
        addMessage('bot', greeting);
      }, 300);
    });
  }
})();
</script>

{% endblock %}
