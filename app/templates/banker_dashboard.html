<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Banker Dashboard - DhanSetu</title>
  <link rel="stylesheet" href="/static/css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
</head>

<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="brand">
      <span class="brand-text">Dhan</span><span>Setu</span>
    </div>
    <div class="links">
      <a href="/banker-dashboard" class="active">Dashboard</a>
      <a href="/chat">Chat</a>
      <button id="btn-logout" class="btn">Logout</button>
    </div>
  </nav>

  <!-- Banker Dashboard -->
  <section class="container">
    <div class="dashboard-header">
      <h1 class="page-title">Banker Dashboard</h1>
      <p class="page-subtitle">Manage loan applications and KYC verification</p>
    </div>

    <!-- Key Metrics -->
    <div class="metrics-grid">
      <div class="metric-card">
        <h3>Total KYC</h3>
        <p class="metric-value" id="m-total-kyc">0</p>
      </div>
      <div class="metric-card">
        <h3>Verified KYC</h3>
        <p class="metric-value" id="m-verified-kyc">0</p>
      </div>
      <div class="metric-card">
        <h3>Total Loans</h3>
        <p class="metric-value" id="m-total-loans">0</p>
      </div>
      <div class="metric-card">
        <h3>Approved Loans</h3>
        <p class="metric-value" id="m-approved-loans">0</p>
      </div>
    </div>

    <div class="dashboard-grid">
      <!-- KYC ID Checker -->
      <div class="dashboard-card">
        <h3>KYC ID Verification</h3>
        <div class="kyc-checker">
          <div class="form-group">
            <label for="kyc-search-input">Search by KYC ID or Upload QR</label>
            <div class="search-row">
              <input type="text" id="kyc-search-input" placeholder="Enter KYC ID (e.g., KYC123456)" />
              <button class="btn" id="btn-search-kyc">Search</button>
            </div>
            <div class="qr-upload">
              <input type="file" id="qr-upload" accept="image/*" style="display:none" />
              <button class="btn-secondary" id="btn-upload-qr">üì∑ Upload QR</button>
            </div>
          </div>
          <div id="kyc-result" class="kyc-result"></div>
        </div>
      </div>

      <!-- PDF Document Validator -->
      <div class="dashboard-card">
        <h3>PDF Document Validation</h3>
        <div class="pdf-validator">
          <div class="form-group">
            <label for="pdf-upload">Upload KYC PDF for Validation</label>
            <input type="file" id="pdf-upload" accept=".pdf" />
            <button class="btn" id="btn-validate-pdf">Validate Document</button>
          </div>
          <div id="pdf-result" class="pdf-result"></div>
        </div>
      </div>

      <!-- Recent KYC -->
      <div class="dashboard-card">
        <h3>Recent KYC Applications</h3>
        <div class="table-container">
          <table class="table" id="tbl-kyc">
            <thead>
              <tr><th>KYC ID</th><th>Name</th><th>Status</th><th>Created</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Eligible + Verified KYC with PDF -->
      <div class="dashboard-card">
        <h3>Eligible & Verified KYC</h3>
        <div class="table-container">
          <table class="table" id="tbl-eligible">
            <thead>
              <tr><th>KYC ID</th><th>Name</th><th>Email</th><th>Loan ID</th><th>Created</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Recent Loans -->
      <div class="dashboard-card">
        <h3>Recent Loan Applications</h3>
        <div class="table-container">
          <table class="table" id="tbl-loans">
            <thead>
              <tr><th>ID</th><th>Status</th><th>Created</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Application Tracker -->
      <div class="dashboard-card full-width">
        <h3>Application Tracker</h3>
        <div class="filter-section">
          <div class="filter-grid">
            <div class="form-group">
              <label for="flt-status">Status</label>
              <select id="flt-status">
                <option value="">Any</option>
                <option value="draft">Draft</option>
                <option value="submitted">Submitted</option>
                <option value="under_review">Under Review</option>
                <option value="approved">Approved</option>
                <option value="declined">Declined</option>
              </select>
            </div>
            <div class="form-group">
              <label for="flt-from">From</label>
              <input type="date" id="flt-from" />
            </div>
            <div class="form-group">
              <label for="flt-to">To</label>
              <input type="date" id="flt-to" />
            </div>
            <div class="form-group">
              <button class="btn" id="btn-apply">Apply Filters</button>
            </div>
          </div>
        </div>
        <div class="table-container">
          <table class="table" id="tbl-tracker">
            <thead>
              <tr><th>ID</th><th>Applicant</th><th>Email</th><th>Amount</th><th>Term</th><th>Status</th><th>Created</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <script>
    function byId(id) { return document.getElementById(id); }

    (async function(){
      // Logout handler
      const lg = document.getElementById('btn-logout');
      if(lg){
        lg.addEventListener('click', async ()=>{
          try{
            await fetch('/api/auth/banker/logout', {method:'POST', credentials:'include'});
          }catch{}
          location.href = '/banker-login';
        });
      }

      // KYC ID Search functionality
      const searchKycBtn = document.getElementById('btn-search-kyc');
      const kycSearchInput = document.getElementById('kyc-search-input');
      const kycResult = document.getElementById('kyc-result');

      searchKycBtn.addEventListener('click', async () => {
        const kycId = kycSearchInput.value.trim();
        if (!kycId) {
          kycResult.innerHTML = '<div class="error">Please enter a KYC ID</div>';
          return;
        }

        kycResult.innerHTML = '<div class="loading">Searching...</div>';
        
        try {
          const response = await fetch(`/api/banker/kyc/${kycId}`, { credentials:'include' });
          const data = await response.json();
          
          if (response.ok) {
            displayKycResult(data, kycResult);
          } else {
            kycResult.innerHTML = `<div class="error">${data.error || 'KYC not found'}</div>`;
          }
        } catch (error) {
          kycResult.innerHTML = '<div class="error">Error searching KYC</div>';
        }
      });

      // QR Code Upload functionality
      const uploadQrBtn = document.getElementById('btn-upload-qr');
      const qrUpload = document.getElementById('qr-upload');

      uploadQrBtn.addEventListener('click', () => qrUpload.click());

      qrUpload.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        kycResult.innerHTML = '<div class="loading">Processing QR code...</div>';
        
        const formData = new FormData();
        formData.append('qr_image', file);

        try {
          const response = await fetch('/api/banker/kyc/qr-scan', {
            method: 'POST',
            body: formData,
            credentials: 'include'
          });
          const data = await response.json();
          
          if (response.ok) {
            displayKycResult(data, kycResult);
          } else {
            kycResult.innerHTML = `<div class="error">${data.error || 'QR scan failed'}</div>`;
          }
        } catch (error) {
          kycResult.innerHTML = '<div class="error">Error scanning QR code</div>';
        }
      });

      // PDF Validation functionality
      const validatePdfBtn = document.getElementById('btn-validate-pdf');
      const pdfUpload = document.getElementById('pdf-upload');
      const pdfResult = document.getElementById('pdf-result');

      validatePdfBtn.addEventListener('click', async () => {
        const file = pdfUpload.files[0];
        if (!file) {
          pdfResult.innerHTML = '<div class="error">Please select a PDF file</div>';
          return;
        }

        pdfResult.innerHTML = '<div class="loading">Validating document...</div>';
        
        const formData = new FormData();
        formData.append('pdf_document', file);

        try {
          const response = await fetch('/api/banker/kyc/validate-pdf', {
            method: 'POST',
            body: formData,
            credentials: 'include'
          });
          const data = await response.json();
          
          if (response.ok) {
            displayPdfResult(data, pdfResult);
          } else {
            pdfResult.innerHTML = `<div class="error">${data.error || 'PDF validation failed'}</div>`;
          }
        } catch (error) {
          pdfResult.innerHTML = '<div class="error">Error validating PDF</div>';
        }
      });

      // Display KYC Result
      function displayKycResult(data, container) {
        const statusClass = data.verified ? 'verified' : 'pending';
        const statusText = data.verified ? '‚úÖ Verified' : '‚è≥ Pending';
        
        container.innerHTML = `
          <div class="kyc-details ${statusClass}">
            <h4>KYC Found - ${statusText}</h4>
            <div class="detail-grid">
              <div><strong>KYC ID:</strong> ${data.kyc_id}</div>
              <div><strong>Name:</strong> ${data.full_name}</div>
              <div><strong>Email:</strong> ${data.email}</div>
              <div><strong>Phone:</strong> ${data.phone}</div>
              <div><strong>Status:</strong> ${data.status}</div>
              <div><strong>Created:</strong> ${new Date(data.created_at).toLocaleString()}</div>
              ${data.loan_id ? `<div><strong>Loan ID:</strong> ${data.loan_id}</div>` : ''}
            </div>
            <div class="verification-status">
              <span class="status-badge ${data.verified ? 'verified' : 'pending'}">
                ${data.verified ? '‚úÖ Genuine User' : '‚ö†Ô∏è Verification Pending'}
              </span>
            </div>
            <div class="action-buttons">
              <button class="btn btn-download-pdf" onclick="downloadKycPdf('${data.kyc_id}')">
                üìÑ Download KYC PDF
              </button>
            </div>
          </div>
        `;
      }

      // Download KYC PDF function
      window.downloadKycPdf = async function(kycId) {
        try {
          const response = await fetch(`/api/banker/kyc/${kycId}/pdf`, {
            credentials: 'include'
          });
          
          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `${kycId}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
          } else {
            const errorData = await response.json();
            alert(`Failed to download PDF: ${errorData.error || 'Unknown error'}`);
          }
        } catch (error) {
          alert(`Error downloading PDF: ${error.message}`);
        }
      };

      // Display PDF Result
      function displayPdfResult(data, container) {
        const isValid = data.valid;
        const statusClass = isValid ? 'verified' : 'invalid';
        
        container.innerHTML = `
          <div class="pdf-details ${statusClass}">
            <h4>PDF Validation - ${isValid ? '‚úÖ Valid' : '‚ùå Invalid'}</h4>
            <div class="detail-grid">
              <div><strong>Document Name:</strong> ${data.filename}</div>
              <div><strong>File Size:</strong> ${(data.file_size / 1024).toFixed(2)} KB</div>
              <div><strong>Document Type:</strong> ${data.document_type}</div>
              <div><strong>Extracted KYC ID:</strong> ${data.extracted_kyc_id || 'N/A'}</div>
              <div><strong>Checksum Valid:</strong> ${data.checksum_valid ? '‚úÖ Yes' : '‚ùå No'}</div>
              <div><strong>Timestamp:</strong> ${new Date(data.timestamp).toLocaleString()}</div>
            </div>
            <div class="validation-issues">
              ${data.issues && data.issues.length > 0 ? 
                `<h5>Issues Found:</h5><ul>${data.issues.map(issue => `<li>${issue}</li>`).join('')}</ul>` : 
                '<div class="no-issues">‚úÖ No issues detected</div>'
              }
            </div>
          </div>
        `;
      }

      // Fetch summary
      try{
        const sRes = await fetch('/api/banker/analytics/summary', {credentials:'include'});
        const s = await sRes.json();
        if(sRes.ok){
          byId('m-total-kyc').textContent = s.total_kyc;
          byId('m-verified-kyc').textContent = s.verified_kyc;
          byId('m-total-loans').textContent = s.total_loans;
          byId('m-approved-loans').textContent = s.approved_loans;
        }
      }catch{}

      // Recent KYC
      try{
        const r = await fetch('/api/banker/analytics/recent-kyc', {credentials:'include'});
        const data = await r.json();
        if(r.ok){
          const tb = document.querySelector('#tbl-kyc tbody');
          tb.innerHTML = '';
          (data.items||[]).forEach(it=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${it.kyc_id||''}</td><td>${it.name||''}</td><td>${it.status||''}</td><td>${(it.created_at||'').replace('T',' ').replace('Z','')}</td>`;
            tb.appendChild(tr);
          });
          if((data.items||[]).length === 0){
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="4">No recent KYC applications</td>';
            tb.appendChild(tr);
          }
        }
      }catch{}

      // Recent loans
      try{
        const r = await fetch('/api/banker/analytics/recent-loans', {credentials:'include'});
        const data = await r.json();
        if(r.ok){
          const tb = document.querySelector('#tbl-loans tbody');
          tb.innerHTML = '';
          (data.items||[]).forEach(it=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${it.id}</td><td>${it.status||''}</td><td>${(it.created_at||'').replace('T',' ').replace('Z','')}</td>`;
            tb.appendChild(tr);
          });
          if((data.items||[]).length === 0){
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="3">No recent loan applications</td>';
            tb.appendChild(tr);
          }
        }
      }catch{}

      // Eligible + Verified KYC with PDF
      try{
        const r = await fetch('/api/banker/eligible-kyc', {credentials:'include'});
        const data = await r.json();
        if(r.ok){
          const tb = document.querySelector('#tbl-eligible tbody');
          tb.innerHTML = '';
          (data.items||[]).forEach(it=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${it.kyc_id}</td><td>${it.name||''}</td><td>${it.email||''}</td><td>${it.loan_id||''}</td><td>${(it.created_at||'').replace('T',' ').replace('Z','')}</td><td><a class="btn" href="${it.pdf_url}" target="_blank">Download PDF</a></td>`;
            tb.appendChild(tr);
          });
          if(tb.children.length===0){
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="6">No eligible verified KYC found.</td>';
            tb.appendChild(tr);
          }
        } else {
          const tb = document.querySelector('#tbl-eligible tbody');
          tb.innerHTML = '';
          const tr = document.createElement('tr');
          const msg = r.status===401 ? 'Please log in as banker to view eligible KYC.' : (data && data.error ? data.error : 'Failed to load eligible KYC');
          tr.innerHTML = `<td colspan="6">${msg}</td>`;
          tb.appendChild(tr);
        }
      }catch{}

      // Tracker fetcher
      async function loadTracker(){
        const qs = new URLSearchParams();
        const s = byId('flt-status').value.trim();
        const f = byId('flt-from').value.trim();
        const t = byId('flt-to').value.trim();
        if(s) qs.set('status', s);
        if(f) qs.set('from', f);
        if(t) qs.set('to', t);
        const r = await fetch('/api/banker/applications?'+qs.toString(), {credentials:'include'});
        const data = await r.json();
        if(r.ok){
          const tb = document.querySelector('#tbl-tracker tbody');
          tb.innerHTML = '';
          (data.items||[]).forEach(it=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${it.id}</td><td>${it.full_name||''}</td><td>${it.email||''}</td><td>${it.amount||''}</td><td>${it.term||''}</td><td>${it.status||''}</td><td>${(it.created_at||'').replace('T',' ').replace('Z','')}</td>`;
            tb.appendChild(tr);
          });
          if((data.items||[]).length===0){
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="7">No applications for selected filters.</td>';
            tb.appendChild(tr);
          }
        }
      }
      byId('btn-apply').addEventListener('click', loadTracker);
      loadTracker();
    })();
  </script>

  <style>
    .dashboard-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .page-title {
      font-size: 36px;
      color: #fff;
      margin-bottom: 10px;
    }
    
    .page-subtitle {
      color: var(--muted);
      font-size: 18px;
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .metric-card {
      background: rgba(20,20,34,.8);
      border: 1px solid rgba(255,255,255,.08);
      padding: 24px;
      text-align: center;
    }
    
    .metric-card h3 {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .metric-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--acc);
      margin: 0;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 24px;
    }
    
    .dashboard-card {
      background: rgba(20,20,34,.8);
      border: 1px solid rgba(255,255,255,.08);
      padding: 24px;
    }
    
    .dashboard-card.full-width {
      grid-column: 1 / -1;
    }
    
    .dashboard-card h3 {
      color: #fff;
      margin-bottom: 16px;
      font-size: 20px;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th,
    .table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,.1);
      color: var(--white);
    }
    
    .table th {
      background: rgba(255,255,255,.05);
      font-weight: 600;
      color: var(--muted);
    }
    
    .filter-section {
      margin-bottom: 20px;
    }
    
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      align-items: end;
    }
    
    .filter-grid .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .filter-grid label {
      color: var(--white);
      margin-bottom: 6px;
      font-size: 14px;
    }
    
    .filter-grid select,
    .filter-grid input {
      padding: 8px;
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.2);
      color: #fff;
    }

    /* KYC Verification Styles */
    .kyc-checker,
    .pdf-validator {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .kyc-checker .form-group,
    .pdf-validator .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .kyc-checker label,
    .pdf-validator label {
      color: #fff;
      font-weight: 500;
      font-size: 14px;
    }

    .search-row {
      display: flex;
      gap: 8px;
    }

    .search-row input {
      flex: 1;
      padding: 10px;
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.2);
      color: #fff;
      border-radius: 6px;
    }

    .qr-upload {
      margin-top: 8px;
    }

    .btn-secondary {
      background: rgba(255,255,255,.1);
      color: #fff;
      padding: 8px 16px;
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s;
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,.2);
    }

    .kyc-result,
    .pdf-result {
      margin-top: 16px;
    }

    .kyc-details,
    .pdf-details {
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 8px;
      padding: 16px;
    }

    .kyc-details.verified,
    .pdf-details.verified {
      border-color: rgba(34,197,94,.5);
      background: rgba(34,197,94,.1);
    }

    .kyc-details.pending,
    .pdf-details.invalid {
      border-color: rgba(239,68,68,.5);
      background: rgba(239,68,68,.1);
    }

    .kyc-details h4,
    .pdf-details h4 {
      color: #fff;
      margin: 0 0 12px 0;
      font-size: 16px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px;
      margin-bottom: 12px;
    }

    .detail-grid div {
      color: #ccc;
      font-size: 14px;
    }

    .detail-grid strong {
      color: #fff;
    }

    .verification-status {
      text-align: center;
      margin-top: 12px;
    }

    .action-buttons {
      text-align: center;
      margin-top: 16px;
    }

    .btn-download-pdf {
      background: rgba(34,197,94,.2);
      color: #22c55e;
      border: 1px solid rgba(34,197,94,.3);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.3s;
    }

    .btn-download-pdf:hover {
      background: rgba(34,197,94,.3);
      transform: translateY(-1px);
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.verified {
      background: rgba(34,197,94,.2);
      color: #22c55e;
      border: 1px solid rgba(34,197,94,.3);
    }

    .status-badge.pending {
      background: rgba(239,68,68,.2);
      color: #ef4444;
      border: 1px solid rgba(239,68,68,.3);
    }

    .validation-issues {
      margin-top: 12px;
    }

    .validation-issues h5 {
      color: #fff;
      margin: 8px 0;
      font-size: 14px;
    }

    .validation-issues ul {
      margin: 0;
      padding-left: 20px;
      color: #ef4444;
    }

    .validation-issues li {
      margin-bottom: 4px;
      font-size: 13px;
    }

    .no-issues {
      color: #22c55e;
      font-size: 14px;
      font-weight: 500;
    }

    .loading,
    .error {
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      font-size: 14px;
    }

    .loading {
      background: rgba(255,255,255,.1);
      color: #ccc;
    }

    .error {
      background: rgba(239,68,68,.2);
      color: #ef4444;
      border: 1px solid rgba(239,68,68,.3);
    }
    
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .filter-grid {
        grid-template-columns: 1fr;
      }

      .search-row {
        flex-direction: column;
      }

      .detail-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</body>
</html>
