<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Dashboard - DhanSetu</title>
  <link rel="stylesheet" href="/static/css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
</head>

<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="brand">
      <span class="brand-text">Dhan</span><span>Setu</span>
    </div>
    <div class="links">
      <a href="/user-dashboard" class="active">Dashboard</a>
      <a href="/loan">Apply Loan</a>
      <a href="/kyc">KYC</a>
      <a href="/chat">Chat</a>
      <a href="/auth/logout" class="btn">Logout</a>
    </div>
  </nav>

  <!-- User Dashboard -->
  <section class="container">
    <div class="dashboard-header">
      <h1 class="page-title">User Dashboard</h1>
      <p class="page-subtitle">Welcome back! Manage your finances here.</p>
    </div>

    <div class="dashboard-grid">
      <!-- Quick Actions -->
      <div class="dashboard-card">
        <h3>Quick Actions</h3>
        <div class="action-buttons">
          <a href="/loan" class="btn">Apply for Loan</a>
          <a href="/kyc" class="btn secondary">Complete KYC</a>
          <a href="/chat" class="btn secondary">Chat Support</a>
        </div>
      </div>

      <!-- My Applications -->
      <div class="dashboard-card">
        <h3>My Loan Applications</h3>
        <div id="loan-applications">
          <p>Loading your applications...</p>
        </div>
      </div>

      <!-- KYC Status -->
      <div class="dashboard-card">
        <h3>KYC Status</h3>
        <div id="kyc-status">
          <p>Loading KYC information...</p>
        </div>
      </div>

      <!-- Next Steps -->
      <div class="dashboard-card">
        <h3>Next Steps</h3>
        <ul class="steps-list">
          <li>Complete your loan application</li>
          <li>Submit KYC documents for verification</li>
          <li>Track your application status</li>
          <li>Get approved and receive funds</li>
        </ul>
      </div>
    </div>
  </section>

  <script>
    (async function() {
      // Helper to render latest eligibility summary
      function renderEligibilitySummary(items){
        if(!Array.isArray(items) || items.length===0) return '';
        const latest = items[0];
        const pred = (latest.prediction||'').toLowerCase();
        const predColor = pred==='eligible' ? '#34d399' : pred==='ineligible' ? '#f87171' : '#fbbf24';
        const note = pred==='eligible'
          ? 'Great! Proceed to KYC to continue.'
          : 'You can try improving inputs (income, lower EMIs, better credit) and check again.';
        return `
          <div class="dashboard-card" style="margin-bottom:16px">
            <h3>Latest Eligibility</h3>
            <p>Application #${latest.id} • Status: <strong>${latest.status}</strong> • Prediction: <strong style="color:${predColor}">${latest.prediction||'-'}</strong></p>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
              <span style="color: var(--muted)">${note}</span>
              <a href="/loan" class="btn">Try Again / Improve</a>
              ${pred==='eligible' ? '<a href="/kyc" class="btn secondary">Proceed to KYC</a>' : ''}
            </div>
          </div>`;
      }

      // Load KYC Status
      try {
        const response = await fetch('/api/kyc/me', { credentials: 'include' });
        const data = await response.json();
        const kycBox = document.getElementById('kyc-status');
        
        if (!response.ok) {
          kycBox.innerHTML = `<p style="color: #f87171;">${data.error || 'Unable to load KYC'}</p>`;
        } else if (!data.exists) {
          kycBox.innerHTML = `
            <p style="color: #fbbf24;">KYC Not Started</p>
            <p><a href="/kyc" class="btn">Start KYC Now</a></p>
          `;
        } else {
          const verifiedDate = data.verified_at ? new Date(data.verified_at).toLocaleDateString() : 'Not verified';
          kycBox.innerHTML = `
            <p><strong>KYC ID:</strong> ${data.kyc_id || '-'}</p>
            <p><strong>Status:</strong> <span style="color: ${data.status === 'verified' ? '#34d399' : '#fbbf24'}">${data.status}</span></p>
            <p><strong>Verified:</strong> ${verifiedDate}</p>
            ${data.kyc_id ? `<p><a href="/api/kyc/me/pdf" target="_blank" class="btn secondary">Download PDF</a></p>` : ''}
          `;
        }
      } catch (error) {
        document.getElementById('kyc-status').innerHTML = '<p style="color: #f87171;">Unable to load KYC</p>';
      }

      // Load Loan Applications (with prediction)
      try {
        const response = await fetch('/api/loan/my', { credentials: 'include' });
        const data = await response.json();
        const loanBox = document.getElementById('loan-applications');
        
        if (response.ok && data.items && data.items.length > 0) {
          let html = '';
          html += renderEligibilitySummary(data.items);
          html += '<div class="loan-list">';
          data.items.forEach(loan => {
            const statusColor = loan.status === 'approved' ? '#34d399' : loan.status === 'pending' ? '#fbbf24' : '#f87171';
            const pred = (loan.prediction||'').toLowerCase();
            const predColor = pred==='eligible' ? '#34d399' : pred==='ineligible' ? '#f87171' : '#fbbf24';
            html += `
              <div class="loan-item">
                <p><strong>Application #${loan.id}</strong></p>
                <p>Amount: ₹${loan.amount || 'N/A'}</p>
                <p>Term: ${loan.term || 'N/A'} months</p>
                <p>Status: <span style="color: ${statusColor}">${loan.status || 'N/A'}</span></p>
                <p>Eligibility: <span style="color:${predColor}">${loan.prediction || 'N/A'}</span></p>
                <p>Created: ${new Date(loan.created_at).toLocaleDateString()}</p>
              </div>
            `;
          });
          html += '</div>';
          loanBox.innerHTML = html;
        } else {
          loanBox.innerHTML = `
            <p>No loan applications yet.</p>
            <p><a href="/loan" class="btn">Apply for Your First Loan</a></p>
          `;
        }
      } catch (error) {
        document.getElementById('loan-applications').innerHTML = '<p style="color: #f87171;">Unable to load applications</p>';
      }
    })();
  </script>

  <style>
    .dashboard-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .page-title {
      font-size: 36px;
      color: #fff;
      margin-bottom: 10px;
    }
    
    .page-subtitle {
      color: var(--muted);
      font-size: 18px;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-top: 40px;
    }
    
    .dashboard-card {
      background: rgba(20,20,34,.8);
      border: 1px solid rgba(255,255,255,.08);
      padding: 24px;
    }
    
    .dashboard-card h3 {
      color: #fff;
      margin-bottom: 16px;
      font-size: 20px;
    }
    
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .loan-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .loan-item {
      background: rgba(255,255,255,.05);
      padding: 16px;
      border: 1px solid rgba(255,255,255,.1);
    }
    
    .loan-item p {
      margin: 4px 0;
      color: var(--white);
    }
    
    .steps-list {
      list-style: none;
      padding: 0;
    }
    
    .steps-list li {
      color: var(--muted);
      margin: 12px 0;
      padding-left: 20px;
      position: relative;
    }
    
    .steps-list li:before {
      content: "→";
      position: absolute;
      left: 0;
      color: var(--acc);
    }
    
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</body>
</html>
